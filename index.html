<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse des tables de p√©rim√®tre d'archivage STIME</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #1d4ed8; color: white; }
        .chart-container { height: 400px; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .impact-icon { font-size: 3rem; color: #10b981; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .metric-card-calc { transition: all 0.3s ease; }
        .metric-card-calc:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .input-focus:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .table-clickable { cursor: pointer; transition: all 0.2s ease; }
        .table-clickable:hover { background-color: #f3f4f6; transform: translateX(4px); }
        .module-clickable { cursor: pointer; transition: all 0.2s ease; padding: 8px; border-radius: 8px; }
        .module-clickable:hover { background-color: #f3f4f6; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 500px; margin: 1rem; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        
        /* Styles pour l'√©dition am√©lior√©s */
        .editable { position: relative; }
        .editable:hover .edit-btn, .editable:hover .color-btn { opacity: 1; }
        .edit-btn, .color-btn { 
            opacity: 0; 
            position: absolute; 
            top: -5px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            cursor: pointer; 
            font-size: 12px;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .edit-btn { right: -5px; }
        .color-btn { right: 25px; background: #8b5cf6; }
        
        .edit-toolbar { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            background: white; 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            z-index: 1001;
            display: none;
        }
        
        /* Menu contextuel */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 4px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1002;
            min-width: 150px;
        }
        .context-menu .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .context-menu .menu-item:hover {
            background-color: #f3f4f6;
        }
        
        .chart-bar:hover { cursor: pointer; opacity: 0.8; }
        
        /* Chatbot styles */
        .chatbot { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1000; 
        }
        .chatbot-button { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .chatbot-window { 
            position: absolute; 
            bottom: 70px; 
            right: 0; 
            width: 350px; 
            height: 400px; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
            display: none;
            flex-direction: column;
        }
        .chatbot-header { 
            background: #3b82f6; 
            color: white; 
            padding: 15px; 
            border-radius: 12px 12px 0 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .chatbot-messages { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
        }
        .chatbot-input { 
            display: flex; 
            padding: 15px; 
            border-top: 1px solid #e5e7eb;
        }
        .message { 
            max-width: 80%; 
            padding: 8px 12px; 
            border-radius: 12px; 
            word-wrap: break-word;
        }
        .user-message { 
            background: #3b82f6; 
            color: white; 
            align-self: flex-end; 
        }
        .bot-message { 
            background: #f3f4f6; 
            color: #374151; 
            align-self: flex-start; 
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Barre d'outils d'√©dition -->
    <div id="editToolbar" class="edit-toolbar">
        <div class="flex gap-2">
            <button onclick="enableEditMode()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                <i class="fas fa-edit"></i> √âditer
            </button>
            <button onclick="saveChanges()" class="px-3 py-1 bg-green-500 text-white rounded text-sm">
                <i class="fas fa-save"></i> Enregistrer
            </button>
        </div>
    </div>

    <!-- En-t√™te -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 mx-4 mt-4 editable" data-element="header">
        <h1 class="text-4xl font-bold text-gray-800 mb-2 editable" data-element="title">Analyse des tables de p√©rim√®tre d'archivage STIME</h1>
        <p class="text-xl text-gray-600 mb-1 editable" data-element="subtitle">Optimisation m√©tier et empreinte environnementale</p>
        <p class="text-lg text-blue-600 font-semibold editable" data-element="team">√âquipe Data Science ‚Äì Systnaps</p>
        <p class="text-sm text-gray-500 editable" data-element="date">Juillet 2025 (Extraction 08/06/2025)</p>
    </div>

    <!-- Navigation par onglets -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mx-4 mb-6">
        <div class="bg-blue-600 flex flex-wrap">
            <button class="tab-button active px-6 py-3 text-white font-medium hover:bg-blue-700 transition-colors" onclick="showTab('introduction')">
                <i class="fas fa-home mr-2"></i>Introduction
            </button>
            <button class="tab-button px-6 py-3 text-white font-medium hover:bg-blue-700 transition-colors" onclick="showTab('tables')">
                <i class="fas fa-table mr-2"></i>Analyse par table
            </button>
            <button class="tab-button px-6 py-3 text-white font-medium hover:bg-blue-700 transition-colors" onclick="showTab('modules')">
                <i class="fas fa-cubes mr-2"></i>Analyse par module m√©tier
            </button>
            <button class="tab-button px-6 py-3 text-white font-medium hover:bg-blue-700 transition-colors" onclick="showTab('modeles')">
                <i class="fas fa-sitemap mr-2"></i>Analyse par mod√®le m√©tier
            </button>
            <button class="tab-button px-6 py-3 text-white font-medium hover:bg-blue-700 transition-colors" onclick="showTab('infrastructure')">
                <i class="fas fa-server mr-2"></i>Infrastructure compl√®te
            </button>
            <button class="tab-button px-6 py-3 text-white font-medium hover:bg-blue-700 transition-colors" onclick="showTab('calculateur')">
                <i class="fas fa-calculator mr-2"></i>Calculateur
            </button>
        </div>

        <!-- Contenu des onglets -->
        <div class="p-6">
            <!-- Introduction -->
            <div id="introduction" class="tab-content active">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 editable" data-element="intro-title">Vue d'ensemble de l'analyse</h2>
                
                <!-- M√©triques principales -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div class="metric-card text-white p-6 rounded-lg editable" data-element="metric1">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Tables Analys√©es</p>
                                <p class="text-2xl font-bold">235</p>
                            </div>
                            <i class="fas fa-table text-3xl opacity-75"></i>
                        </div>
                    </div>
                    <div class="metric-card text-white p-6 rounded-lg editable" data-element="metric2">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Volume Purg√©</p>
                                <p class="text-2xl font-bold">242.84 Go</p>
                            </div>
                            <i class="fas fa-database text-3xl opacity-75"></i>
                        </div>
                    </div>
                    <div class="metric-card text-white p-6 rounded-lg editable" data-element="metric3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Volume √âconomis√©</p>
                                <p class="text-2xl font-bold">2914 Go</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl opacity-75"></i>
                        </div>
                    </div>
                    <div class="metric-card text-white p-6 rounded-lg editable" data-element="metric4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">CO‚ÇÇ √âvit√©</p>
                                <p class="text-2xl font-bold">50.87 kg/an</p>
                            </div>
                            <i class="fas fa-leaf text-3xl opacity-75"></i>
                        </div>
                    </div>
                    <div class="metric-card text-white p-6 rounded-lg editable" data-element="metric5">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Facteur √ó</p>
                                <p class="text-2xl font-bold">12</p>
                            </div>
                            <i class="fas fa-times text-3xl opacity-75"></i>
                        </div>
                    </div>
                </div>

                <!-- Graphiques s√©par√©s - Avant/Apr√®s et Gains -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow editable" data-element="chart1-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold editable" data-element="chart1-title">Avant / Apr√®s Purge</h3>
                            <button onclick="changeChartType('beforeAfterChart')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="beforeAfterChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow editable" data-element="chart2-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold editable" data-element="chart2-title">Gains √âconomis√©s (√ó12 Infrastructure + 5 ans)</h3>
                            <button onclick="changeChartType('gainsChart')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="gainsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- √âquivalences environnementales -->
                <div class="bg-white p-6 rounded-lg shadow mb-8 editable" data-element="equivalences">
                    <h3 class="text-xl font-bold mb-4 editable" data-element="equiv-title">√âquivalences Environnementales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center editable" data-element="equiv1">
                            <i class="fas fa-car impact-icon mb-3"></i>
                            <p class="text-2xl font-bold text-gray-800">494 km</p>
                            <p class="text-gray-600">Voiture √©lectrique</p>
                        </div>
                        <div class="text-center editable" data-element="equiv2">
                            <i class="fas fa-bus impact-icon mb-3"></i>
                            <p class="text-2xl font-bold text-gray-800">450 km</p>
                            <p class="text-gray-600">Bus thermique</p>
                        </div>
                        <div class="text-center editable" data-element="equiv3">
                            <i class="fas fa-motorcycle impact-icon mb-3"></i>
                            <p class="text-2xl font-bold text-gray-800">2035 km</p>
                            <p class="text-gray-600">Trottinette √©lectrique</p>
                        </div>
                    </div>
                </div>

                <!-- Objectifs -->
                <div class="bg-white p-6 rounded-lg shadow editable" data-element="objectives">
                    <h3 class="text-xl font-bold mb-4 editable" data-element="obj-title">Objectifs de l'analyse</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-start space-x-3 editable" data-element="obj1">
                            <i class="fas fa-chart-bar text-blue-600 mt-1"></i>
                            <div>
                                <p class="font-semibold">Mesurer l'optimisation</p>
                                <p class="text-sm text-gray-600">Quantifier l'espace de stockage √©conomis√©</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 editable" data-element="obj2">
                            <i class="fas fa-leaf text-green-600 mt-1"></i>
                            <div>
                                <p class="font-semibold">Impact environnemental</p>
                                <p class="text-sm text-gray-600">Calculer la r√©duction des √©missions CO‚ÇÇ</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 editable" data-element="obj3">
                            <i class="fas fa-bullseye text-purple-600 mt-1"></i>
                            <div>
                                <p class="font-semibold">Identifier les domaines</p>
                                <p class="text-sm text-gray-600">Cibler les modules les plus impact√©s</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 editable" data-element="obj4">
                            <i class="fas fa-cogs text-orange-600 mt-1"></i>
                            <div>
                                <p class="font-semibold">Proposer des recommandations</p>
                                <p class="text-sm text-gray-600">Optimiser davantage le syst√®me</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tables -->
            <div id="tables" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 editable" data-element="tables-title">Analyse par Table</h2>
                
                <!-- Interpr√©tations -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 mb-6 editable" data-element="tables-interpretation">
                    <p class="text-blue-800 mb-4">Les 10 tables les plus volumineuses repr√©sentent 87 % du volume √©conomis√©, soit 212 Go sur un total de 243 Go purg√©s.</p>
                    <p class="text-blue-800 mb-4">Ces tables concernent principalement la facturation, la comptabilit√© clients/fournisseurs, le reporting financier et les donn√©es TVA.</p>
                    <p class="text-blue-800">Exemple : la table PS_ITEM_DST est la plus volumineuse (45 Go), avec un gain carbone associ√© important.</p>
                </div>

                <!-- Graphique des tables -->
                <div class="bg-white p-6 rounded-lg shadow mb-6 editable" data-element="tables-chart">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold editable" data-element="tables-chart-title">TOP 10 des Tables les Plus Volumineuses</h3>
                        <button onclick="changeChartType('tablesChart')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="tablesChart"></canvas>
                    </div>
                </div>

                <!-- Liste des tables cliquables -->
                <div class="bg-white rounded-lg shadow overflow-hidden editable" data-element="tables-list">
                    <div class="px-6 py-4 bg-gray-50 border-b">
                        <h3 class="text-xl font-bold editable" data-element="tables-list-title">Tables (cliquez pour plus d'informations)</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table1" onclick="showTableModal('PS_ITEM_DST')">
                            <div>
                                <span class="font-medium text-blue-600">PS_ITEM_DST</span>
                                <span class="ml-2 text-gray-500">Comptabilit√© clients (AR)</span>
                            </div>
                            <span class="text-lg font-bold">45.31 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table2" onclick="showTableModal('PS_VCHR_ACCTG_LINE')">
                            <div>
                                <span class="font-medium text-blue-600">PS_VCHR_ACCTG_LINE</span>
                                <span class="ml-2 text-gray-500">Comptabilit√© fournisseurs (AP)</span>
                            </div>
                            <span class="text-lg font-bold">44.06 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table3" onclick="showTableModal('PS_RPTG_DETAIL_TBL')">
                            <div>
                                <span class="font-medium text-blue-600">PS_RPTG_DETAIL_TBL</span>
                                <span class="ml-2 text-gray-500">Reporting financier</span>
                            </div>
                            <span class="text-lg font-bold">26.61 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table4" onclick="showTableModal('PS_PENDING_DST')">
                            <div>
                                <span class="font-medium text-blue-600">PS_PENDING_DST</span>
                                <span class="ml-2 text-gray-500">Comptabilit√© clients (AR)</span>
                            </div>
                            <span class="text-lg font-bold">13.59 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table5" onclick="showTableModal('PS_ITEM')">
                            <div>
                                <span class="font-medium text-blue-600">PS_ITEM</span>
                                <span class="ml-2 text-gray-500">Comptabilit√© clients (AR)</span>
                            </div>
                            <span class="text-lg font-bold">11.72 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table6" onclick="showTableModal('PS_VAT_RPT_INST2')">
                            <div>
                                <span class="font-medium text-blue-600">PS_VAT_RPT_INST2</span>
                                <span class="ml-2 text-gray-500">Fiscalit√© TVA</span>
                            </div>
                            <span class="text-lg font-bold">9.84 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table7" onclick="showTableModal('PS_PENDING_ITEM')">
                            <div>
                                <span class="font-medium text-blue-600">PS_PENDING_ITEM</span>
                                <span class="ml-2 text-gray-500">Comptabilit√© clients (AR)</span>
                            </div>
                            <span class="text-lg font-bold">9.53 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table8" onclick="showTableModal('PS_VAT_XREF_ITEM')">
                            <div>
                                <span class="font-medium text-blue-600">PS_VAT_XREF_ITEM</span>
                                <span class="ml-2 text-gray-500">Fiscalit√© TVA</span>
                            </div>
                            <span class="text-lg font-bold">7.81 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table9" onclick="showTableModal('PS_RPTG_BALANCE')">
                            <div>
                                <span class="font-medium text-blue-600">PS_RPTG_BALANCE</span>
                                <span class="ml-2 text-gray-500">Reporting financier</span>
                            </div>
                            <span class="text-lg font-bold">7.46 Go</span>
                        </div>
                        <div class="table-clickable px-6 py-4 flex justify-between items-center editable" data-element="table10" onclick="showTableModal('PS_NP_RPTG_OPEN_I')">
                            <div>
                                <span class="font-medium text-blue-600">PS_NP_RPTG_OPEN_I</span>
                                <span class="ml-2 text-gray-500">Reporting financier</span>
                            </div>
                            <span class="text-lg font-bold">7.40 Go</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modules -->
            <div id="modules" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 editable" data-element="modules-title">Analyse par Module M√©tier</h2>
                
                <!-- Interpr√©tations -->
                <div class="bg-green-50 border-l-4 border-green-500 p-6 mb-6 editable" data-element="modules-interpretation">
                    <p class="text-green-800 mb-4">Les modules comptabilit√© clients (AR) et fournisseurs (AP) concentrent plus de 66 % des gains en volume et en CO2 √©vit√©.</p>
                    <p class="text-green-800 mb-4">D'autres modules comme le reporting ou la TVA ont aussi des √©conomies notables.</p>
                    <p class="text-green-800">Certains modules comme la Business Intelligence ne montrent aucun gain, souvent √† cause de volumes faibles ou absence de purge.</p>
                </div>

                <!-- Graphique modules -->
                <div class="bg-white p-6 rounded-lg shadow mb-6 editable" data-element="modules-chart">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold editable" data-element="modules-chart-title">R√©partition par Module (9 modules)</h3>
                        <button onclick="changeChartType('modulesChart')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-chart-pie"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="modulesChart"></canvas>
                    </div>
                </div>

                <!-- Modules cliquables -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="module-clickable bg-blue-100 border-2 border-blue-200 editable" data-element="module-ar" onclick="showModuleModal('AR')">
                        <div class="text-center">
                            <h3 class="font-bold text-blue-800 text-lg">AR</h3>
                            <p class="text-sm text-blue-600 mb-2">Accounts Receivable</p>
                            <p class="text-2xl font-bold text-blue-800">104.27 Go</p>
                            <p class="text-sm text-blue-600">42.9%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-green-100 border-2 border-green-200 editable" data-element="module-ap" onclick="showModuleModal('AP')">
                        <div class="text-center">
                            <h3 class="font-bold text-green-800 text-lg">AP</h3>
                            <p class="text-sm text-green-600 mb-2">Accounts Payable</p>
                            <p class="text-2xl font-bold text-green-800">57.88 Go</p>
                            <p class="text-sm text-green-600">23.8%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-yellow-100 border-2 border-yellow-200 editable" data-element="module-rptg" onclick="showModuleModal('RPTG')">
                        <div class="text-center">
                            <h3 class="font-bold text-yellow-800 text-lg">RPTG</h3>
                            <p class="text-sm text-yellow-600 mb-2">Reporting</p>
                            <p class="text-2xl font-bold text-yellow-800">41.47 Go</p>
                            <p class="text-sm text-yellow-600">17.1%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-purple-100 border-2 border-purple-200 editable" data-element="module-tva" onclick="showModuleModal('TVA')">
                        <div class="text-center">
                            <h3 class="font-bold text-purple-800 text-lg">TVA</h3>
                            <p class="text-sm text-purple-600 mb-2">Taxe sur la Valeur Ajout√©e</p>
                            <p class="text-2xl font-bold text-purple-800">26.07 Go</p>
                            <p class="text-sm text-purple-600">10.7%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-gray-100 border-2 border-gray-200 editable" data-element="module-gl" onclick="showModuleModal('GL')">
                        <div class="text-center">
                            <h3 class="font-bold text-gray-800 text-lg">GL</h3>
                            <p class="text-sm text-gray-600 mb-2">General Ledger</p>
                            <p class="text-2xl font-bold text-gray-800">8.48 Go</p>
                            <p class="text-sm text-gray-600">3.5%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mod√®les -->
            <div id="modeles" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 editable" data-element="models-title">Analyse par Mod√®le M√©tier</h2>
                
                <!-- Interpr√©tations -->
                <div class="bg-purple-50 border-l-4 border-purple-500 p-6 mb-6 editable" data-element="models-interpretation">
                    <p class="text-purple-800 mb-4">Au niveau granulaire, les objets m√©tier les plus consommateurs sont les pi√®ces clients (ITEM), les pi√®ces fournisseurs (AP PIECES), les groupes comptables, et les lignes de reporting.</p>
                    <p class="text-purple-800">Ces objets sont li√©s √† l'activit√© op√©rationnelle quotidienne, donc leur purge a un effet direct sur les performances et l'environnement.</p>
                </div>

                <!-- Graphique mod√®les -->
                <div class="bg-white p-6 rounded-lg shadow mb-6 editable" data-element="models-chart">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold editable" data-element="models-chart-title">Performance par Mod√®le M√©tier (22 mod√®les)</h3>
                        <button onclick="changeChartType('modelesChart')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="modelesChart"></canvas>
                    </div>
                </div>

                <!-- Mod√®les cliquables -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="module-clickable bg-blue-100 border-2 border-blue-200 editable" data-element="model-item" onclick="showModelModal('ITEM')">
                        <div class="text-center">
                            <h3 class="font-bold text-blue-800 text-lg">ITEM</h3>
                            <p class="text-2xl font-bold text-blue-800">71.92 Go</p>
                            <p class="text-sm text-blue-600">29.6%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-green-100 border-2 border-green-200 editable" data-element="model-ap" onclick="showModelModal('AP_PIECES')">
                        <div class="text-center">
                            <h3 class="font-bold text-green-800 text-lg">AP PIECES</h3>
                            <p class="text-2xl font-bold text-green-800">56.00 Go</p>
                            <p class="text-sm text-green-600">23.1%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-yellow-100 border-2 border-yellow-200 editable" data-element="model-group" onclick="showModelModal('GROUP')">
                        <div class="text-center">
                            <h3 class="font-bold text-yellow-800 text-lg">GROUP</h3>
                            <p class="text-2xl font-bold text-yellow-800">32.34 Go</p>
                            <p class="text-sm text-yellow-600">13.3%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-purple-100 border-2 border-purple-200 editable" data-element="model-rptg" onclick="showModelModal('RPTG_DETAIL')">
                        <div class="text-center">
                            <h3 class="font-bold text-purple-800 text-lg">RPTG DETAIL</h3>
                            <p class="text-2xl font-bold text-purple-800">26.61 Go</p>
                            <p class="text-sm text-purple-600">11.0%</p>
                        </div>
                    </div>
                    <div class="module-clickable bg-red-100 border-2 border-red-200 editable" data-element="model-tva" onclick="showModelModal('TVA')">
                        <div class="text-center">
                            <h3 class="font-bold text-red-800 text-lg">TVA</h3>
                            <p class="text-2xl font-bold text-red-800">26.07 Go</p>
                            <p class="text-sm text-red-600">10.7%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Infrastructure -->
            <div id="infrastructure" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 editable" data-element="infra-title">Infrastructure Compl√®te</h2>
                
                <!-- M√©thodologie -->
                <div class="bg-white p-6 rounded-lg shadow mb-6 editable" data-element="methodology">
                    <h3 class="text-xl font-bold mb-4 editable" data-element="method-title">M√©thodologie</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="editable" data-element="variables">
                            <h4 class="font-semibold mb-3">Variables et Notations</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>Vp</strong> = Volume purg√© (242.84 Go)</p>
                                <p><strong>E</strong> = Nombre d'environnements (5 pour STIME)</p>
                                <p><strong>Be</strong> = Copies de backup par environnement</p>
                                <p><strong>r</strong> = Ratio d'archivage (0 pour STIME)</p>
                                <p><strong>f</strong> = Facteur CO‚ÇÇ (0.0175 kg/Go¬∑an)</p>
                                <p><strong>t</strong> = Dur√©e en ann√©es</p>
                            </div>
                        </div>
                        <div class="editable" data-element="formulas">
                            <h4 class="font-semibold mb-3">Formules</h4>
                            <div class="bg-gray-50 p-4 rounded space-y-2 text-sm font-mono">
                                <p><strong>ŒîV = Vp √ó (1‚àír) √ó Œ£(1+Be)</strong></p>
                                <p><strong>ŒîCO‚ÇÇ = ŒîV √ó f</strong></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration STIME -->
                <div class="bg-white p-6 rounded-lg shadow mb-6 editable" data-element="stime-config">
                    <h3 class="text-xl font-bold mb-4 editable" data-element="config-title">Configuration STIME (Simulation)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="editable" data-element="environments">
                            <h4 class="font-semibold mb-2">Environnements</h4>
                            <ul class="space-y-1 text-sm">
                                <li>‚Ä¢ Production : 1 + 3 backups = 4 copies</li>
                                <li>‚Ä¢ Test : 1 + 2 backups = 3 copies</li>
                                <li>‚Ä¢ Recette : 1 + 2 backups = 3 copies</li>
                                <li>‚Ä¢ D√©veloppement : 1 + 1 backup = 2 copies</li>
                                <li>‚Ä¢ Formation : 1 + 0 backup = 1 copie</li>
                            </ul>
                        </div>
                        <div class="editable" data-element="factor">
                            <div class="bg-blue-50 p-4 rounded">
                                <p class="font-semibold text-blue-800">Total facteur : √ó12</p>
                                <p class="text-sm text-blue-600">Chaque Go purg√© en production = 12 Go √©conomis√©s dans l'infrastructure compl√®te</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R√©sultats -->
                <div class="bg-white p-6 rounded-lg shadow mb-6 editable" data-element="results">
                    <h3 class="text-xl font-bold mb-4 editable" data-element="results-title">R√©sultats du Rapport</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="editable" data-element="direct-impact">
                            <h4 class="font-semibold mb-3">Impact Direct</h4>
                            <div class="space-y-2 text-sm">
                                <p>Volume purg√© en production : <strong>242.84 Go</strong></p>
                                <p>Volume √©conomis√© infrastructure : <strong>2914 Go</strong></p>
                                <p>Impact CO‚ÇÇ annuel : <strong>50.87 kg/an</strong></p>
                                <p>Impact sur 5 ans : <strong>254.35 kg CO‚ÇÇ</strong></p>
                            </div>
                        </div>
                        <div class="editable" data-element="env-equivalences">
                            <h4 class="font-semibold mb-3">√âquivalences Environnementales</h4>
                            <div class="space-y-2 text-sm">
                                <p>üöó <strong>494 km</strong> en voiture √©lectrique</p>
                                <p>üöå <strong>450 km</strong> en bus thermique</p>
                                <p>üõ¥ <strong>2035 km</strong> en trottinette √©lectrique</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphique amplification -->
                <div class="bg-white p-6 rounded-lg shadow editable" data-element="amplification-chart">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold editable" data-element="amplif-title">Facteur Multiplicateur par Type d'Infrastructure</h3>
                        <button onclick="changeChartType('amplificationChart')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="amplificationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Calculateur -->
            <div id="calculateur" class="tab-content">
                <div class="gradient-bg text-white py-8 rounded-lg mb-8 editable" data-element="calc-header">
                    <div class="container mx-auto px-4">
                        <div class="text-center">
                            <h1 class="text-4xl font-bold mb-2 editable" data-element="calc-title">
                                <i class="fas fa-leaf mr-3"></i>
                                Calculatrice ERP - Impact Environnemental
                            </h1>
                            <p class="text-xl opacity-90 editable" data-element="calc-subtitle">Analyse de l'impact des purges de donn√©es sur l'empreinte carbone</p>
                        </div>
                    </div>
                </div>

                <!-- Configuration Section -->
                <section class="mb-8">
                    <div class="bg-white rounded-lg card-shadow p-6 editable" data-element="calc-config">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center editable" data-element="config-section-title">
                            <i class="fas fa-cogs mr-3 text-blue-600"></i>
                            Configuration des Param√®tres
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Param√®tres de Base -->
                            <div class="editable" data-element="base-params">
                                <h3 class="text-lg font-medium text-gray-700 mb-4">Param√®tres de Base</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Volume Purg√© (Go)</label>
                                        <input type="number" id="volumePurged" value="242.84" step="0.01" 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ratio d'Archivage</label>
                                        <input type="number" id="archiveRatio" value="0" step="0.01" min="0" max="1"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Facteur CO‚ÇÇ (kg/Go¬∑an)</label>
                                        <input type="number" id="co2Factor" value="0.0175" step="0.0001"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
                                    </div>
                                </div>
                            </div>

                            <!-- Profils Pr√©d√©finis -->
                            <div class="editable" data-element="predefined-profiles">
                                <h3 class="text-lg font-medium text-gray-700 mb-4">Profils Pr√©d√©finis</h3>
                                <div class="space-y-3">
                                    <button onclick="loadProfile('PME')" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-building mr-2"></i>PME Standard (√ó6)
                                    </button>
                                    <button onclick="loadProfile('ETI')" class="w-full bg-green-100 hover:bg-green-200 text-green-800 py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-industry mr-2"></i>ETI Standard (√ó12)
                                    </button>
                                    <button onclick="loadProfile('Groupe')" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-globe mr-2"></i>Groupe Enterprise (√ó20)
                                    </button>
                                    <button onclick="loadProfile('STIME')" class="w-full bg-orange-100 hover:bg-orange-200 text-orange-800 py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-server mr-2"></i>STIME (√ó12)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Environnements -->
                        <div class="mt-8 editable" data-element="env-config">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">Configuration des Environnements</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="environmentsConfig">
                                <!-- Environnements seront ajout√©s dynamiquement -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- R√©sultats Section -->
                <section class="mb-8">
                    <div class="bg-white rounded-lg card-shadow p-6 editable" data-element="calc-results">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center editable" data-element="results-section-title">
                            <i class="fas fa-chart-line mr-3 text-green-600"></i>
                            R√©sultats de l'Analyse
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="metric-card-calc bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg editable" data-element="calc-metric1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100 text-sm">Gains Totaux</p>
                                        <p class="text-2xl font-bold" id="totalGains">-</p>
                                        <p class="text-blue-100 text-xs" id="totalGainsTiB">-</p>
                                    </div>
                                    <i class="fas fa-hdd text-3xl text-blue-200"></i>
                                </div>
                            </div>
                            
                            <div class="metric-card-calc bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg editable" data-element="calc-metric2">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm">CO‚ÇÇ √âvit√©</p>
                                        <p class="text-2xl font-bold" id="co2Avoided">-</p>
                                        <p class="text-green-100 text-xs">kg/an</p>
                                    </div>
                                    <i class="fas fa-leaf text-3xl text-green-200"></i>
                                </div>
                            </div>
                            
                            <div class="metric-card-calc bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg editable" data-element="calc-metric3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-purple-100 text-sm">√âquivalent Voiture</p>
                                        <p class="text-2xl font-bold" id="carEquivalent">-</p>
                                        <p class="text-purple-100 text-xs">km √©vit√©s</p>
                                    </div>
                                    <i class="fas fa-car text-3xl text-purple-200"></i>
                                </div>
                            </div>
                            
                            <div class="metric-card-calc bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg editable" data-element="calc-metric4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-orange-100 text-sm">√âquivalent Trottinette</p>
                                        <p class="text-2xl font-bold" id="scooterEquivalent">-</p>
                                        <p class="text-orange-100 text-xs">km √©vit√©s</p>
                                    </div>
                                    <i class="fas fa-motorcycle text-3xl text-orange-200"></i>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg editable" data-element="calc-details">
                                <h4 class="font-medium text-gray-700 mb-3">D√©tail des Calculs</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Volume initial purg√©:</span>
                                        <span id="initialVolume" class="font-medium">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Facteur de duplication:</span>
                                        <span id="duplicationFactor" class="font-medium">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Volume total √©conomis√©:</span>
                                        <span id="totalVolumeEconomized" class="font-medium">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Impact CO‚ÇÇ annuel:</span>
                                        <span id="annualCO2" class="font-medium">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg editable" data-element="calc-projections">
                                <h4 class="font-medium text-gray-700 mb-3">Projections 5 ans</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>CO‚ÇÇ √©vit√© total:</span>
                                        <span id="totalCO2_5years" class="font-medium">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Stockage √©conomis√©:</span>
                                        <span id="totalStorage_5years" class="font-medium">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>√âquivalent voiture:</span>
                                        <span id="carEquivalent_5years" class="font-medium">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Visualisations Section -->
                <section class="mb-8">
                    <div class="bg-white rounded-lg card-shadow p-6 editable" data-element="calc-visualizations">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center editable" data-element="viz-section-title">
                            <i class="fas fa-chart-bar mr-3 text-indigo-600"></i>
                            Visualisations
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="editable" data-element="env-chart">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-medium text-gray-700">R√©partition par Environnement</h3>
                                    <button onclick="changeChartType('environmentChart')" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-chart-pie"></i>
                                    </button>
                                </div>
                                <div class="chart-container">
                                    <canvas id="environmentChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="editable" data-element="projection-chart">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-medium text-gray-700">Projections Temporelles</h3>
                                    <button onclick="changeChartType('projectionChart')" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-chart-line"></i>
                                    </button>
                                </div>
                                <div class="chart-container">
                                    <canvas id="projectionChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 editable" data-element="waterfall-chart">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium text-gray-700">Analyse Waterfall - Accumulation des Gains</h3>
                                <button onclick="changeChartType('waterfallChart')" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="waterfallChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Summary Section -->
                <section class="mb-8">
                    <div class="bg-white rounded-lg card-shadow p-6 editable" data-element="calc-summary">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center editable" data-element="summary-section-title">
                            <i class="fas fa-clipboard-check mr-3 text-teal-600"></i>
                            Synth√®se Ex√©cutive
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 p-6 rounded-lg editable" data-element="env-impact">
                                <h3 class="text-lg font-semibold text-blue-800 mb-3">Impact Environnemental</h3>
                                <ul class="space-y-2 text-sm text-blue-700">
                                    <li class="flex items-start">
                                        <i class="fas fa-check-circle mr-2 mt-1 text-blue-600"></i>
                                        <span id="summaryEnvironmental">Calcul en cours...</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="bg-green-50 p-6 rounded-lg editable" data-element="recommendations">
                                <h3 class="text-lg font-semibold text-green-800 mb-3">Recommandations</h3>
                                <ul class="space-y-2 text-sm text-green-700">
                                    <li class="flex items-start">
                                        <i class="fas fa-lightbulb mr-2 mt-1 text-green-600"></i>
                                        <span id="summaryRecommendations">Analyse en cours...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6 bg-gray-50 p-6 rounded-lg editable" data-element="methodology-summary">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">M√©thodologie</h3>
                            <div class="text-sm text-gray-600 space-y-2">
                                <p><strong>Formule principale:</strong> ŒîV = Vp √ó (1-r) √ó Œ£(1+Be)</p>
                                <p><strong>Impact CO‚ÇÇ:</strong> ŒîCO‚ÇÇ = ŒîV √ó 0,0175 kg CO‚ÇÇ/Go¬∑an (facteur ADEME)</p>
                                <p><strong>√âquivalences:</strong> Voiture √©lectrique: 1.03 kg CO‚ÇÇ/10km | Trottinette: 0.25 kg CO‚ÇÇ/10km</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="tableModalTitle">Table Information</h3>
                <button onclick="closeModal('tableModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="tableModalContent"></div>
        </div>
    </div>

    <div id="moduleModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="moduleModalTitle">Module Information</h3>
                <button onclick="closeModal('moduleModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="moduleModalContent"></div>
        </div>
    </div>

    <div id="modelModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modelModalTitle">Mod√®le Information</h3>
                <button onclick="closeModal('modelModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modelModalContent"></div>
        </div>
    </div>

    <!-- Modal d'√©dition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">√âditer l'√©l√©ment</h3>
                <button onclick="closeModal('editModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="editModalContent">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Texte</label>
                        <textarea id="editText" class="w-full p-2 border rounded" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Couleur</label>
                        <input type="color" id="editColor" class="w-full h-10 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Taille (px)</label>
                        <input type="number" id="editSize" class="w-full p-2 border rounded" min="8" max="72">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="applyEdit()" class="px-4 py-2 bg-blue-500 text-white rounded">Appliquer</button>
                        <button onclick="deleteElement()" class="px-4 py-2 bg-red-500 text-white rounded">Supprimer</button>
                        <button onclick="closeModal('editModal')" class="px-4 py-2 bg-gray-500 text-white rounded">Annuler</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot">
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>Assistant STIME</h3>
                <button onclick="toggleChatbot()" class="text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="message bot-message">
                    Bonjour ! Je peux vous aider avec des informations sur les 235 tables, 9 modules, 22 mod√®les, volumes √©conomis√©s (2914 Go), impact CO‚ÇÇ (50.87 kg/an), ou formules de calcul. Que souhaitez-vous savoir ?
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" placeholder="Posez votre question..." class="flex-1 p-2 border rounded-l" onkeypress="handleChatbotEnter(event)">
                <button onclick="sendChatbotMessage()" class="px-4 py-2 bg-blue-500 text-white rounded-r">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        <button class="chatbot-button" onclick="toggleChatbot()">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <script>
        // Variables globales
        let environmentChart = null;
        let projectionChart = null;
        let waterfallChart = null;
        let editingElement = null;
        let editMode = false;
        
        // Configuration des profils
        const profiles = {
            PME: {
                name: 'PME Standard',
                environments: {
                    'Production': { instances: 1, backups: 3 },
                    'Test': { instances: 1, backups: 1 },
                    'D√©veloppement': { instances: 1, backups: 1 }
                }
            },
            ETI: {
                name: 'ETI Standard',
                environments: {
                    'Production': { instances: 1, backups: 3 },
                    'Test': { instances: 1, backups: 2 },
                    'Recette': { instances: 1, backups: 2 },
                    'D√©veloppement': { instances: 2, backups: 1 }
                }
            },
            Groupe: {
                name: 'Groupe Enterprise',
                environments: {
                    'Production': { instances: 1, backups: 4 },
                    'Test': { instances: 1, backups: 3 },
                    'Recette': { instances: 1, backups: 2 },
                    'D√©veloppement': { instances: 2, backups: 2 },
                    'Formation': { instances: 1, backups: 1 },
                    'Pr√©-production': { instances: 1, backups: 2 }
                }
            },
            STIME: {
                name: 'STIME',
                environments: {
                    'Production': { instances: 1, backups: 3 },
                    'Test': { instances: 1, backups: 2 },
                    'Recette': { instances: 1, backups: 2 },
                    'D√©veloppement': { instances: 1, backups: 1 },
                    'Formation': { instances: 1, backups: 0 }
                }
            }
        };

        // Donn√©es des tables
        const tableInfo = {
            'PS_ITEM_DST': {
                function: 'Table de distribution des √©l√©ments factur√©s aux clients',
                content: 'Lignes de facturation distribu√©es par entit√© comptable',
                business: 'Comptabilit√© clients (AR)'
            },
            'PS_VCHR_ACCTG_LINE': {
                function: 'Lignes comptables des pi√®ces fournisseurs',
                content: 'D√©tail des √©critures comptables fournisseurs',
                business: 'Comptabilit√© fournisseurs (AP)'
            },
            'PS_RPTG_DETAIL_TBL': {
                function: 'D√©tails des rapports de gestion financi√®re',
                content: 'Donn√©es d√©taill√©es pour rapports consolid√©s',
                business: 'Reporting financier'
            },
            'PS_PENDING_DST': {
                function: 'Distribution des encours clients en attente',
                content: 'Encours clients non encore factur√©s',
                business: 'Comptabilit√© clients (AR)'
            },
            'PS_ITEM': {
                function: 'R√©f√©rentiel des √©l√©ments comptables',
                content: 'Master data des √©l√©ments facturables',
                business: 'Comptabilit√© clients (AR)'
            },
            'PS_VAT_RPT_INST2': {
                function: 'Instances de rapports TVA',
                content: 'Snapshots des d√©clarations TVA',
                business: 'Fiscalit√© TVA'
            },
            'PS_PENDING_ITEM': {
                function: '√âl√©ments comptables en attente de traitement',
                content: 'Items en cours de validation',
                business: 'Comptabilit√© clients (AR)'
            },
            'PS_VAT_XREF_ITEM': {
                function: 'R√©f√©rences crois√©es TVA/Items',
                content: 'Table de correspondance TVA-√©l√©ments',
                business: 'Fiscalit√© TVA'
            },
            'PS_RPTG_BALANCE': {
                function: 'Balances de reporting consolid√©',
                content: 'Soldes comptables pour reporting',
                business: 'Reporting financier'
            },
            'PS_NP_RPTG_OPEN_I': {
                function: '√âcritures ouvertes de reporting',
                content: '√âcritures non sold√©es pour rapports',
                business: 'Reporting financier'
            }
        };

        // Donn√©es des modules
        const moduleInfo = {
            'AR': {
                name: 'Accounts Receivable',
                function: 'Gestion de la comptabilit√© clients',
                processes: 'Facturation, encaissement, relances',
                tables: 'PS_ITEM_DST, PS_PENDING_DST, PS_ITEM, PS_PENDING_ITEM',
                impact: '42.9% des gains totaux'
            },
            'AP': {
                name: 'Accounts Payable',
                function: 'Gestion de la comptabilit√© fournisseurs',
                processes: 'Saisie pi√®ces, validation, paiements',
                tables: 'PS_VCHR_ACCTG_LINE',
                impact: '23.8% des gains totaux'
            },
            'RPTG': {
                name: 'Reporting',
                function: 'Production de rapports financiers',
                processes: 'Consolidation, √©tats de gestion',
                tables: 'PS_RPTG_DETAIL_TBL, PS_RPTG_BALANCE, PS_NP_RPTG_OPEN_I',
                impact: '17.1% des gains totaux'
            },
            'TVA': {
                name: 'Taxe sur la Valeur Ajout√©e',
                function: 'Gestion fiscale de la TVA',
                processes: 'D√©clarations, rapports fiscaux',
                tables: 'PS_VAT_RPT_INST2, PS_VAT_XREF_ITEM',
                impact: '10.7% des gains totaux'
            },
            'GL': {
                name: 'General Ledger',
                function: 'Comptabilit√© g√©n√©rale',
                processes: '√âcritures comptables, grand livre',
                tables: 'Tables GL diverses',
                impact: '3.5% des gains totaux'
            }
        };

        // Donn√©es des mod√®les
        const modelInfo = {
            'ITEM': {
                function: 'Gestion des √©l√©ments factur√©s et comptables',
                processes: 'Pi√®ces clients, facturation',
                impact: '29.6% des gains'
            },
            'AP_PIECES': {
                function: 'Pi√®ces comptables fournisseurs',
                processes: 'Gestion fournisseurs',
                impact: '23.1% des gains'
            },
            'GROUP': {
                function: 'Groupes comptables et consolidation',
                processes: 'Consolidation comptable',
                impact: '13.3% des gains'
            },
            'RPTG_DETAIL': {
                function: 'D√©tails de reporting financier',
                processes: 'Reporting d√©taill√©',
                impact: '11.0% des gains'
            },
            'TVA': {
                function: 'Gestion de la taxe sur la valeur ajout√©e',
                processes: 'D√©clarations TVA',
                impact: '10.7% des gains'
            }
        };

        // Donn√©es STIME pour le chatbot - CORRIG√âES
        const stimeData = {
            tables: 235,
            modules: 9,
            modeles: 22,
            volumePurge: 242.84,
            volumeEconomise: 2914,
            co2Evite: 50.87, // Valeur corrig√©e
            facteur: 12,
            modulesList: ['AR', 'AP', 'RPTG', 'TVA', 'GL', 'RECO', 'FS', 'BI', 'PRE'],
            topTables: ['PS_ITEM_DST', 'PS_VCHR_ACCTG_LINE', 'PS_RPTG_DETAIL_TBL', 'PS_PENDING_DST', 'PS_ITEM']
        };

        // Ajouter le menu contextuel
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.editable')) {
                e.preventDefault();
                const element = e.target.closest('.editable');
                
                // Supprimer les menus existants
                document.querySelectorAll('.context-menu').forEach(menu => menu.remove());
                
                // Cr√©er menu contextuel
                const menu = document.createElement('div');
                menu.className = 'context-menu';
                menu.style.top = e.clientY + 'px';
                menu.style.left = e.clientX + 'px';
                
                menu.innerHTML = `
                    <div class="menu-item">
                        <i class="fas fa-edit"></i> Modifier
                    </div>
                    <div class="menu-item">
                        <i class="fas fa-trash"></i> Supprimer
                    </div>
                `;
                
                // Ajouter les √©v√©nements
                menu.querySelector('.menu-item:first-child').onclick = () => {
                    editElement(element);
                    menu.remove();
                };
                
                menu.querySelector('.menu-item:last-child').onclick = () => {
                    deleteElement();
                    editingElement = element;
                    menu.remove();
                };
                
                document.body.appendChild(menu);
                
                // Fermer le menu en cliquant ailleurs
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu() {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    });
                }, 0);
            }
        });

        // Fonctions d'√©dition am√©lior√©es
        function enableEditMode() {
            editMode = true;
            document.getElementById('editToolbar').style.display = 'block';
            
            // Ajouter les boutons d'√©dition et de couleur
            document.querySelectorAll('.editable').forEach(element => {
                element.style.position = 'relative';
                
                if (!element.querySelector('.edit-btn')) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.innerHTML = '‚úèÔ∏è';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        editElement(element);
                    };
                    element.appendChild(editBtn);
                }
                
                if (!element.querySelector('.color-btn')) {
                    const colorBtn = document.createElement('button');
                    colorBtn.className = 'color-btn';
                    colorBtn.innerHTML = 'üé®';
                    colorBtn.onclick = (e) => {
                        e.stopPropagation();
                        showColorPicker(element);
                    };
                    element.appendChild(colorBtn);
                }
            });
        }

        function showColorPicker(element) {
            const picker = document.createElement('input');
            picker.type = 'color';
            picker.value = rgbToHex(window.getComputedStyle(element).color);
            picker.style.display = 'none';
            document.body.appendChild(picker);
            
            picker.addEventListener('change', (e) => {
                element.style.color = e.target.value;
                saveChanges();
                picker.remove();
            });
            
            picker.click();
        }

        function editElement(element) {
            editingElement = element;
            
            // Remplir le modal avec les valeurs actuelles
            const textContent = element.textContent || element.innerText;
            const color = window.getComputedStyle(element).color;
            const fontSize = window.getComputedStyle(element).fontSize;
            
            document.getElementById('editText').value = textContent;
            document.getElementById('editColor').value = rgbToHex(color);
            document.getElementById('editSize').value = parseInt(fontSize);
            
            document.getElementById('editModal').classList.add('active');
        }

        function applyEdit() {
            if (!editingElement) return;
            
            const newText = document.getElementById('editText').value;
            const newColor = document.getElementById('editColor').value;
            const newSize = document.getElementById('editSize').value;
            
            editingElement.textContent = newText;
            editingElement.style.color = newColor;
            editingElement.style.fontSize = newSize + 'px';
            
            closeModal('editModal');
            saveChanges();
        }

        function deleteElement() {
            if (!editingElement) return;
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?')) {
                editingElement.style.display = 'none';
                closeModal('editModal');
                saveChanges();
            }
        }

        function saveChanges() {
            // Sauvegarder dans localStorage
            const changes = {};
            document.querySelectorAll('.editable').forEach(element => {
                const id = element.getAttribute('data-element');
                if (id) {
                    changes[id] = {
                        text: element.textContent,
                        color: element.style.color,
                        fontSize: element.style.fontSize,
                        display: element.style.display
                    };
                }
            });
            
            localStorage.setItem('stimeChanges', JSON.stringify(changes));
            alert('Modifications sauvegard√©es !');
        }

        function loadChanges() {
            const changes = localStorage.getItem('stimeChanges');
            if (changes) {
                const parsedChanges = JSON.parse(changes);
                Object.keys(parsedChanges).forEach(id => {
                    const element = document.querySelector(`[data-element="${id}"]`);
                    if (element && parsedChanges[id]) {
                        const change = parsedChanges[id];
                        if (change.text) element.textContent = change.text;
                        if (change.color) element.style.color = change.color;
                        if (change.fontSize) element.style.fontSize = change.fontSize;
                        if (change.display) element.style.display = change.display;
                    }
                });
            }
        }

        // Fonctions de changement de style de graphique
        function changeChartType(chartId) {
            const types = ['bar', 'line', 'pie', 'doughnut'];
            const currentChart = window[chartId.replace('Chart', '') + 'ChartInstance'];
            
            if (currentChart) {
                const currentType = currentChart.config.type;
                const currentIndex = types.indexOf(currentType);
                const nextType = types[(currentIndex + 1) % types.length];
                
                currentChart.config.type = nextType;
                currentChart.update();
            }
        }

        // Fonctions Chatbot am√©lior√©es
        function toggleChatbot() {
            const window = document.getElementById('chatbotWindow');
            window.style.display = window.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleChatbotEnter(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }

        function sendChatbotMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ajouter message utilisateur
            addChatbotMessage(message, 'user');
            
            // G√©n√©rer r√©ponse
            const response = generateChatbotResponse(message);
            setTimeout(() => {
                addChatbotMessage(response, 'bot');
            }, 500);
            
            input.value = '';
        }

        function addChatbotMessage(message, type) {
            const messages = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = message;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function generateChatbotResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Salutations
            if (lowerMessage.includes('bonjour') || lowerMessage.includes('salut') || lowerMessage.includes('hello')) {
                return 'Bonjour ! Comment puis-je vous aider avec l\'analyse STIME ?';
            }
            
            // Questions sur les tables
            if (lowerMessage.includes('table') || lowerMessage.includes('nombre de table')) {
                return `Nous avons ${stimeData.tables} tables uniques analys√©es. Les plus volumineuses sont ${stimeData.topTables.slice(0,3).join(', ')}.`;
            }
            
            // Questions sur les modules
            if (lowerMessage.includes('module')) {
                return `Il y a ${stimeData.modules} modules m√©tier : ${stimeData.modulesList.join(', ')}. Les modules AR et AP repr√©sentent 66.7% des gains.`;
            }
            
            // Questions sur les mod√®les
            if (lowerMessage.includes('mod√®le') || lowerMessage.includes('modele')) {
                return `L'analyse couvre ${stimeData.modeles} mod√®les m√©tier au total. Les plus impactants sont ITEM (29.6%), AP PIECES (23.1%), et GROUP (13.3%).`;
            }
            
            // Questions sur les volumes
            if (lowerMessage.includes('volume') || lowerMessage.includes('go') || lowerMessage.includes('espace')) {
                return `Volume purg√© : ${stimeData.volumePurge} Go. Volume √©conomis√© avec l'infrastructure (√ó${stimeData.facteur}) : ${stimeData.volumeEconomise} Go.`;
            }
            
            // Questions sur le CO2
            if (lowerMessage.includes('co2') || lowerMessage.includes('carbone') || lowerMessage.includes('environnement')) {
                return `Impact CO‚ÇÇ √©vit√© : ${stimeData.co2Evite} kg/an, soit l'√©quivalent de 494 km en voiture √©lectrique ou 2035 km en trottinette.`;
            }
            
            // Questions sur les calculs
            if (lowerMessage.includes('calcul') || lowerMessage.includes('formule') || lowerMessage.includes('facteur')) {
                return `Formule principale : ŒîV = Vp √ó (1-r) √ó Œ£(1+Be). Facteur multiplicateur STIME : √ó${stimeData.facteur}. Facteur CO‚ÇÇ : 0.0175 kg/Go¬∑an.`;
            }
            
            // Au revoir
            if (lowerMessage.includes('merci') || lowerMessage.includes('au revoir') || lowerMessage.includes('bye')) {
                return 'Je vous en prie ! N\'h√©sitez pas si vous avez d\'autres questions sur l\'analyse STIME.';
            }
            
            // R√©ponse par d√©faut
            return 'Je peux vous renseigner sur les 235 tables, 9 modules, 22 mod√®les, volumes √©conomis√©s, impact CO‚ÇÇ, ou formules de calcul. Pouvez-vous pr√©ciser votre question ?';
        }

        // Fonctions utilitaires
        function rgbToHex(rgb) {
            const result = rgb.match(/\d+/g);
            if (!result || result.length < 3) return '#000000';
            return '#' + ((1 << 24) + (parseInt(result[0]) << 16) + (parseInt(result[1]) << 8) + parseInt(result[2])).toString(16).slice(1);
        }

        // Navigation par onglets
        function showTab(tabName) {
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Modals
        function showTableModal(tableName) {
            const info = tableInfo[tableName];
            document.getElementById('tableModalTitle').textContent = tableName;
            document.getElementById('tableModalContent').innerHTML = `
                <div class="space-y-3">
                    <div><strong>Fonction:</strong> ${info.function}</div>
                    <div><strong>Contenu:</strong> ${info.content}</div>
                    <div><strong>M√©tier:</strong> ${info.business}</div>
                </div>
            `;
            document.getElementById('tableModal').classList.add('active');
        }

        function showModuleModal(moduleName) {
            const info = moduleInfo[moduleName];
            document.getElementById('moduleModalTitle').textContent = `${moduleName} - ${info.name}`;
            document.getElementById('moduleModalContent').innerHTML = `
                <div class="space-y-3">
                    <div><strong>Fonction:</strong> ${info.function}</div>
                    <div><strong>Processus:</strong> ${info.processes}</div>
                    <div><strong>Tables principales:</strong> ${info.tables}</div>
                    <div><strong>Impact:</strong> ${info.impact}</div>
                </div>
            `;
            document.getElementById('moduleModal').classList.add('active');
        }

        function showModelModal(modelName) {
            const info = modelInfo[modelName];
            document.getElementById('modelModalTitle').textContent = modelName.replace('_', ' ');
            document.getElementById('modelModalContent').innerHTML = `
                <div class="space-y-3">
                    <div><strong>Fonction:</strong> ${info.function}</div>
                    <div><strong>Processus:</strong> ${info.processes}</div>
                    <div><strong>Impact:</strong> ${info.impact}</div>
                </div>
            `;
            document.getElementById('modelModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Fonctions du calculateur avec valeurs corrig√©es
        function loadProfile(profileName) {
            const profile = profiles[profileName];
            if (!profile) return;

            const container = document.getElementById('environmentsConfig');
            container.innerHTML = '';

            Object.entries(profile.environments).forEach(([envName, config]) => {
                const envDiv = document.createElement('div');
                envDiv.className = 'bg-gray-50 p-4 rounded-lg';
                envDiv.innerHTML = `
                    <h4 class="font-medium text-gray-700 mb-3">${envName}</h4>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Instances</label>
                            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded input-focus text-sm" 
                                   value="${config.instances}" min="1" data-env="${envName}" data-type="instances">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Backups</label>
                            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded input-focus text-sm" 
                                   value="${config.backups}" min="0" data-env="${envName}" data-type="backups">
                        </div>
                    </div>
                `;
                container.appendChild(envDiv);
            });

            addEventListeners();
            calculateAll();
        }

        function addEventListeners() {
            ['volumePurged', 'archiveRatio', 'co2Factor'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateAll);
                }
            });

            document.querySelectorAll('#environmentsConfig input').forEach(input => {
                input.addEventListener('input', calculateAll);
            });
        }

        function getEnvironmentsConfig() {
            const environments = {};
            document.querySelectorAll('#environmentsConfig > div').forEach(envDiv => {
                const envName = envDiv.querySelector('h4').textContent;
                const instancesInput = envDiv.querySelector('input[data-type="instances"]');
                const backupsInput = envDiv.querySelector('input[data-type="backups"]');
                
                environments[envName] = {
                    instances: parseInt(instancesInput.value) || 1,
                    backups: parseInt(backupsInput.value) || 0
                };
            });
            return environments;
        }

        function calculateDuplicationFactor(environments) {
            let totalFactor = 0;
            Object.values(environments).forEach(env => {
                totalFactor += env.instances * (1 + env.backups);
            });
            return totalFactor;
        }

        function calculateAll() {
            const volumePurged = parseFloat(document.getElementById('volumePurged')?.value) || 242.84;
            const archiveRatio = parseFloat(document.getElementById('archiveRatio')?.value) || 0;
            const co2Factor = parseFloat(document.getElementById('co2Factor')?.value) || 0.0175; // Valeur corrig√©e
            const environments = getEnvironmentsConfig();

            const duplicationFactor = calculateDuplicationFactor(environments);
            const totalVolumeEconomized = volumePurged * (1 - archiveRatio) * duplicationFactor;
            const annualCO2 = totalVolumeEconomized * co2Factor;
            
            const carEquivalent = Math.round((annualCO2 / 1.03) * 10);
            const scooterEquivalent = Math.round((annualCO2 / 0.25) * 10);
            
            const totalCO2_5years = annualCO2 * 5;
            const totalStorage_5years = totalVolumeEconomized * 5;
            const carEquivalent_5years = carEquivalent * 5;

            updateDisplay({
                volumePurged,
                duplicationFactor,
                totalVolumeEconomized,
                annualCO2,
                carEquivalent,
                scooterEquivalent,
                totalCO2_5years,
                totalStorage_5years,
                carEquivalent_5years,
                environments
            });

            updateCharts({
                volumePurged,
                totalVolumeEconomized,
                annualCO2,
                environments,
                duplicationFactor
            });
        }

        function updateDisplay(results) {
            if (document.getElementById('totalGains')) {
                document.getElementById('totalGains').textContent = `${results.totalVolumeEconomized.toFixed(2)} Go`;
                document.getElementById('totalGainsTiB').textContent = `${(results.totalVolumeEconomized / 1024).toFixed(2)} TiB`;
                document.getElementById('co2Avoided').textContent = `${results.annualCO2.toFixed(2)}`;
                document.getElementById('carEquivalent').textContent = `${results.carEquivalent.toLocaleString()}`;
                document.getElementById('scooterEquivalent').textContent = `${results.scooterEquivalent.toLocaleString()}`;
                
                document.getElementById('initialVolume').textContent = `${results.volumePurged.toFixed(2)} Go`;
                document.getElementById('duplicationFactor').textContent = `√ó${results.duplicationFactor}`;
                document.getElementById('totalVolumeEconomized').textContent = `${results.totalVolumeEconomized.toFixed(2)} Go`;
                document.getElementById('annualCO2').textContent = `${results.annualCO2.toFixed(2)} kg`;
                
                document.getElementById('totalCO2_5years').textContent = `${results.totalCO2_5years.toFixed(2)} kg`;
                document.getElementById('totalStorage_5years').textContent = `${results.totalStorage_5years.toFixed(2)} Go`;
                document.getElementById('carEquivalent_5years').textContent = `${results.carEquivalent_5years.toLocaleString()} km`;

                updateSummary(results);
            }
        }

        function updateSummary(results) {
            const environmental = `R√©duction de ${results.annualCO2.toFixed(2)} kg CO‚ÇÇ/an gr√¢ce √† l'√©conomie de ${results.totalVolumeEconomized.toFixed(2)} Go de stockage, √©quivalent √† ${results.carEquivalent.toLocaleString()} km en voiture √©vit√©s.`;
            const recommendations = `Focus sur les modules AR et AP qui repr√©sentent 66.7% des gains. Potentiel d'optimisation : ${(results.totalCO2_5years / 1000).toFixed(1)} tonnes CO‚ÇÇ sur 5 ans.`;
            
            if (document.getElementById('summaryEnvironmental')) {
                document.getElementById('summaryEnvironmental').textContent = environmental;
                document.getElementById('summaryRecommendations').textContent = recommendations;
            }
        }

        function updateCharts(data) {
            updateEnvironmentChart(data);
            updateProjectionChart(data);
            updateWaterfallChart(data);
        }

        function updateEnvironmentChart(data) {
            const ctx = document.getElementById('environmentChart')?.getContext('2d');
            if (!ctx) return;
            
            if (environmentChart) {
                environmentChart.destroy();
            }

            const labels = Object.keys(data.environments);
            const values = Object.values(data.environments).map(env => 
                data.volumePurged * env.instances * (1 + env.backups)
            );
            const colors = ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444', '#6B7280'];

            environmentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(2)} Go`;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            if (confirm(`Supprimer l'√©l√©ment "${labels[index]}" ?`)) {
                                labels.splice(index, 1);
                                values.splice(index, 1);
                                environmentChart.data.labels = labels;
                                environmentChart.data.datasets[0].data = values;
                                environmentChart.update();
                            }
                        }
                    }
                }
            });
        }

        function updateProjectionChart(data) {
            const ctx = document.getElementById('projectionChart')?.getContext('2d');
            if (!ctx) return;
            
            if (projectionChart) {
                projectionChart.destroy();
            }

            const years = [1, 2, 3, 4, 5];
            const storageData = years.map(year => data.totalVolumeEconomized * year);
            const co2Data = years.map(year => data.annualCO2 * year);

            projectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => `Ann√©e ${y}`),
                    datasets: [{
                        label: 'Stockage (Go)',
                        data: storageData,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'CO‚ÇÇ (kg)',
                        data: co2Data,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Stockage (Go)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'CO‚ÇÇ (kg)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function updateWaterfallChart(data) {
            const ctx = document.getElementById('waterfallChart')?.getContext('2d');
            if (!ctx) return;
            
            if (waterfallChart) {
                waterfallChart.destroy();
            }

            const labels = ['Volume Initial', ...Object.keys(data.environments), 'Total √âconomis√©'];
            const values = [data.volumePurged];
            
            Object.values(data.environments).forEach(env => {
                values.push(data.volumePurged * env.instances * (1 + env.backups));
            });
            
            values.push(data.totalVolumeEconomized);

            const colors = values.map((_, index) => {
                if (index === 0) return '#6B7280';
                if (index === values.length - 1) return '#10B981';
                return '#3B82F6';
            });

            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume (Go)',
                        data: values,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toFixed(2)} Go`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volume (Go)'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            if (index > 0 && index < labels.length - 1) {
                                if (confirm(`Supprimer l'√©l√©ment "${labels[index]}" ?`)) {
                                    labels.splice(index, 1);
                                    values.splice(index, 1);
                                    colors.splice(index, 1);
                                    waterfallChart.data.labels = labels;
                                    waterfallChart.data.datasets[0].data = values;
                                    waterfallChart.data.datasets[0].backgroundColor = colors;
                                    waterfallChart.update();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadChanges();
            
            setTimeout(() => {
                if (document.getElementById('volumePurged')) {
                    loadProfile('STIME');
                }
            }, 100);
        });

        function initCharts() {
            // Graphique avant/apr√®s - HISTOGRAMME S√âPAR√â
            const ctx1 = document.getElementById('beforeAfterChart')?.getContext('2d');
            if (ctx1) {
                window.beforeAfterChartInstance = new Chart(ctx1, {
                    type: 'bar', // HISTOGRAMME
                    data: {
                        labels: ['Avant Purge', 'Apr√®s Purge'],
                        datasets: [{
                            label: 'Volume (Go)',
                            data: [4557, 4314],
                            backgroundColor: ['#ef4444', '#f59e0b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Avant / Apr√®s Purge'
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const chart = window.beforeAfterChartInstance;
                                if (confirm(`Supprimer "${chart.data.labels[index]}" ?`)) {
                                    chart.data.labels.splice(index, 1);
                                    chart.data.datasets[0].data.splice(index, 1);
                                    chart.data.datasets[0].backgroundColor.splice(index, 1);
                                    chart.update();
                                }
                            }
                        }
                    }
                });
            }

            // Nouveau graphique gains - HISTOGRAMME S√âPAR√â
            const ctx2 = document.getElementById('gainsChart')?.getContext('2d');
            if (ctx2) {
                window.gainsChartInstance = new Chart(ctx2, {
                    type: 'bar', // HISTOGRAMME
                    data: {
                        labels: ['Espace √âconomis√©', '√ó12 Infrastructure', 'Dans 5 ans'],
                        datasets: [{
                            label: 'Volume (Go)',
                            data: [243, 2914, 14570],
                            backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Gains √âconomis√©s'
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const chart = window.gainsChartInstance;
                                if (confirm(`Supprimer "${chart.data.labels[index]}" ?`)) {
                                    chart.data.labels.splice(index, 1);
                                    chart.data.datasets[0].data.splice(index, 1);
                                    chart.data.datasets[0].backgroundColor.splice(index, 1);
                                    chart.update();
                                }
                            }
                        }
                    }
                });
            }

            // Graphique tables
            const ctx3 = document.getElementById('tablesChart')?.getContext('2d');
            if (ctx3) {
                window.tablesChartInstance = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['PS_ITEM_DST', 'PS_VCHR_ACCTG_LINE', 'PS_RPTG_DETAIL_TBL', 'PS_PENDING_DST', 'PS_ITEM', 'PS_VAT_RPT_INST2', 'PS_PENDING_ITEM', 'PS_VAT_XREF_ITEM', 'PS_RPTG_BALANCE', 'PS_NP_RPTG_OPEN_I'],
                        datasets: [{
                            label: 'Volume (Go)',
                            data: [45.31, 44.06, 26.61, 13.59, 11.72, 9.84, 9.53, 7.81, 7.46, 7.40],
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const chart = window.tablesChartInstance;
                                if (confirm(`Supprimer "${chart.data.labels[index]}" ?`)) {
                                    chart.data.labels.splice(index, 1);
                                    chart.data.datasets[0].data.splice(index, 1);
                                    chart.update();
                                }
                            }
                        }
                    }
                });
            }

            // Graphique modules
            const ctx5 = document.getElementById('modulesChart')?.getContext('2d');
            if (ctx5) {
                window.modulesChartInstance = new Chart(ctx5, {
                    type: 'pie',
                    data: {
                        labels: ['AR', 'AP', 'RPTG', 'TVA', 'GL'],
                        datasets: [{
                            data: [104.27, 57.88, 41.47, 26.07, 8.48],
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#6b7280']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const chart = window.modulesChartInstance;
                                if (confirm(`Supprimer "${chart.data.labels[index]}" ?`)) {
                                    chart.data.labels.splice(index, 1);
                                    chart.data.datasets[0].data.splice(index, 1);
                                    chart.data.datasets[0].backgroundColor.splice(index, 1);
                                    chart.update();
                                }
                            }
                        }
                    }
                });
            }

            // Graphique mod√®les
            const ctx7 = document.getElementById('modelesChart')?.getContext('2d');
            if (ctx7) {
                window.modelesChartInstance = new Chart(ctx7, {
                    type: 'bar',
                    data: {
                        labels: ['ITEM', 'AP PIECES', 'GROUP', 'RPTG DETAIL', 'TVA'],
                        datasets: [{
                            label: 'Volume (Go)',
                            data: [71.92, 56.00, 32.34, 26.61, 26.07],
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const chart = window.modelesChartInstance;
                                if (confirm(`Supprimer "${chart.data.labels[index]}" ?`)) {
                                    chart.data.labels.splice(index, 1);
                                    chart.data.datasets[0].data.splice(index, 1);
                                    chart.data.datasets[0].backgroundColor.splice(index, 1);
                                    chart.update();
                                }
                            }
                        }
                    }
                });
            }

            // Graphique amplification
            const ctx10 = document.getElementById('amplificationChart')?.getContext('2d');
            if (ctx10) {
                window.amplificationChartInstance = new Chart(ctx10, {
                    type: 'bar',
                    data: {
                        labels: ['PME (√ó6)', 'ETI (√ó12)', 'Groupe (√ó20)', 'STIME (√ó12)'],
                        datasets: [{
                            label: 'Volume √âconomis√© (Go)',
                            data: [1457, 2914, 4857, 2914],
                            backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const chart = window.amplificationChartInstance;
                                if (confirm(`Supprimer "${chart.data.labels[index]}" ?`)) {
                                    chart.data.labels.splice(index, 1);
                                    chart.data.datasets[0].data.splice(index, 1);
                                    chart.data.datasets[0].backgroundColor.splice(index, 1);
                                    chart.update();
                                }
                            }
                        }
                    }
                });
            }
        }

        // Fermer modals en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modals = ['tableModal', 'moduleModal', 'modelModal', 'editModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        }
    </script>
</body>
</html>
